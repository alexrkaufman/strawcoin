{% extends "base.jinja2" %}
{% block content %}
    <div class="welcome-section">
        <h1 class="welcome-title">🎛️ The CHANCELLOR Terminal</h1>
        <p class="welcome-subtitle">Market Transfer Manipulation Command Center</p>
        <div class="user-balance-card quant-authority">
            <h3>🎯 Welcome, {{ current_username }}</h3>
            <p class="balance-amount">{{ "{:,}".format(current_user_balance) }} Authority Coins</p>
            <p class="status-subtitle">TRANSFER MANIPULATION ACTIVE</p>
        </div>
    </div>
    <!-- Market Overview Dashboard -->
    <div class="quant-panel">
        <h2 class="quant-panel-title">📊 Market Intelligence Dashboard</h2>
        <div class="market-stats-grid">
            <div class="stat-card">
                <h3>💰 Market Cap</h3>
                <p class="stat-value" data-stat="market-cap">{{ "{:,}".format(market_cap) }}</p>
                <p>Total Straw Coins</p>
            </div>
            <div class="stat-card">
                <h3>👥 Active Stakeholders</h3>
                <p class="stat-value" data-stat="user-count">{{ stakeholder_count }}</p>
                <p>Market Participants</p>
            </div>
            <div class="stat-card">
                <h3>📊 Trading Volume</h3>
                <p class="stat-value" data-stat="volume">{{ "{:,}".format(volume) }}</p>
                <p>Total Coins Transferred</p>
            </div>
            <div class="stat-card">
                <h3>🔄 Total Transactions</h3>
                <p class="stat-value" data-stat="tx-count">{{ tx_count }}</p>
                <p>Market Activity</p>
            </div>
        </div>
    </div>
    <!-- Performer Economy Status -->
    <div class="quant-panel">
        <h2 class="quant-panel-title">🎭 Performer Economy Monitor</h2>
        <div class="performer-stats-grid">
            <div class="stat-card">
                <h3>🎪 Performers</h3>
                <p class="stat-value">{{ performer_count }}</p>
                <p>Active on Stage</p>
            </div>
            <div class="stat-card">
                <h3>👥 Audience</h3>
                <p class="stat-value">{{ audience_count }}</p>
                <p>Market Participants</p>
            </div>
            <div class="stat-card">
                <h3>⚡ Redistribution</h3>
                <p class="stat-value">{{ "ON" if redistribution_enabled else "OFF" }}</p>
                <p>{{ "5 coins from each performer to each audience member/min" if redistribution_enabled else "Disabled" }}</p>
            </div>
        </div>
    </div>
    <!-- Market Leaders -->
    <div class="quant-panel">
        <h2 class="quant-panel-title">🏆 Market Leaders</h2>
        <div class="leaderboard-grid">
            {% if top_performers %}
                {% for performer in top_performers %}
                    {% set medals = ["🥇", "🥈", "🥉", "🎖️", "🏅"] %}
                    <div class="leaderboard-item{% if performer.username == current_username %} current-user{% endif %}">
                        <span>{{ medals[loop.index0] if loop.index0 < 5 else "👤" }} {{ performer.username }}</span>
                        <span>{{ "{:,}".format(performer.coin_balance) }} Straw Coins</span>
                    </div>
                {% endfor %}
            {% else %}
                <p class="empty-state">No stakeholders yet</p>
            {% endif %}
        </div>
    </div>
    <!-- Recent Market Activity -->
    {% if recent_transactions %}
        <div class="quant-panel">
            <h2 class="quant-panel-title">📈 Recent Market Activity</h2>
            <div class="transaction-list">
                {% for transaction in recent_transactions %}
                    <div class="transaction-item{% if transaction.sender == current_username %} sent{% else %} received{% endif %}">
                        <div>
                            {% if transaction.sender == current_username %}
                                <span class="transaction-label">📤 Sent to {{ transaction.recipient }}</span>
                            {% else %}
                                <span class="transaction-label">📥 Received from {{ transaction.sender }}</span>
                            {% endif %}
                            <div class="transaction-timestamp">{{ transaction.timestamp.strftime("%Y-%m-%d %H:%M") }}</div>
                        </div>
                        <span class="transaction-amount">
                            {% if transaction.sender == current_username %}
                                -{{ "{:,}".format(transaction.amount) }}
                            {% else %}
                                +{{ "{:,}".format(transaction.amount) }}
                            {% endif %}
                        </span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    <!-- Market Transfer Controls -->
    <div class="quant-terminal-section">
        <h2 class="quant-terminal-title">🕹️ Transfer Control Panel</h2>
        <!-- User Management Panel -->
        <div class="quant-panel">
            <h3 class="quant-panel-title">👥 User Status Management</h3>
            <div class="quant-control-grid">
                <div class="quant-control-card">
                    <h4>🎭 Performer Status Control</h4>
                    <div class="form-group">
                        <label class="form-label">Target User:</label>
                        <input type="text"
                               id="statusUsername"
                               class="form-input"
                               placeholder="Enter username..."
                               list="allUsersList">
                        <datalist id="allUsersList">
                            {% for user in all_users %}
                                <option value="{{ user.username }}">{{ user.username }} ({{ "{:,}".format(user.coin_balance) }} coins)</option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Status:</label>
                        <select id="statusType" class="form-input">
                            <option value="true">🎪 Make Performer</option>
                            <option value="false">👥 Make Audience</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason:</label>
                        <input type="text"
                               id="statusReason"
                               class="form-input"
                               placeholder="Market manipulation reason...">
                    </div>
                    <button id="changeStatusBtn" class="quant-btn quant-btn-primary">⚡ MANIPULATE STATUS</button>
                </div>
                <div class="quant-control-card">
                    <h4>💸 Universal Force Transfer</h4>
                    <div class="form-group">
                        <label class="form-label">From (Sender):</label>
                        <input type="text"
                               id="transferSender"
                               class="form-input"
                               placeholder="Enter sender or select group..."
                               list="senderList">
                        <datalist id="senderList">
                            <option value="All Performers">All Performers (mass transfer from all performers)</option>
                            <option value="All Audience">All Audience (mass transfer from all audience)</option>
                            {% for user in all_users %}
                                <option value="{{ user.username }}">{{ user.username }} ({{ "{:,}".format(user.coin_balance) }} coins)</option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">To (Recipient):</label>
                        <input type="text"
                               id="transferRecipient"
                               class="form-input"
                               placeholder="Enter recipient or select group..."
                               list="recipientList">
                        <datalist id="recipientList">
                            <option value="All Performers">All Performers (distribute to all performers)</option>
                            <option value="All Audience">All Audience (distribute to all audience)</option>
                            {% for user in all_users %}
                                <option value="{{ user.username }}">{{ user.username }} ({{ "{:,}".format(user.coin_balance) }} coins)</option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount:</label>
                        <input type="number"
                               id="transferAmount"
                               class="form-input"
                               placeholder="Enter amount per transfer...">
                        <small class="form-hint">For group transfers: amount each sender gives to each recipient</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason:</label>
                        <input type="text"
                               id="transferReason"
                               class="form-input"
                               placeholder="Transfer reason...">
                    </div>
                    <button id="forceTransferBtn" class="quant-btn quant-btn-danger">💸 EXECUTE TRANSFER</button>
                    <div class="help-text">
                        <strong>Examples:</strong>
                        <br>
                        • Individual: "performer1" → "audience2" (100 coins)
                        <br>
                        • Mass: "All Performers" → "All Audience" (50 coins each)
                        <br>
                        • Mixed: "All Audience" → "performer1" (25 coins each)
                    </div>
                </div>
            </div>
        </div>
        <!-- Transfer Manipulation Panel -->
        <div class="quant-panel">
            <h3 class="quant-panel-title">📈 Advanced Transfer Controls</h3>
            <div class="quant-control-grid">
                <div class="quant-control-card">
                    <h4>🔄 Force Redistribution</h4>
                    <div class="form-group">
                        <label class="form-label">Multiplier:</label>
                        <input type="number"
                               id="redistributionMultiplier"
                               class="form-input"
                               value="1"
                               min="0.1"
                               max="10"
                               step="0.1">
                        <small class="form-hint">How many redistribution cycles (0.1 - 10x)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason:</label>
                        <input type="text"
                               id="redistributionReason"
                               class="form-input"
                               placeholder="Redistribution reason...">
                    </div>
                    <button id="forceRedistributionBtn" class="quant-btn quant-btn-warning">⚡ FORCE REDISTRIBUTION</button>
                </div>
                <div class="quant-control-card">
                    <h4>📊 Market Intelligence</h4>
                    <button id="refreshStatsBtn" class="quant-btn quant-btn-info">🔄 Refresh Market Data</button>
                    <button id="getAllUsersBtn" class="quant-btn quant-btn-info">👥 Get All Users</button>
                    <button id="getMarketStatsBtn" class="quant-btn quant-btn-info">📈 Detailed Market Stats</button>
                </div>
            </div>
        </div>
        <!-- All Users Registry -->
        <div class="quant-panel">
            <h3 class="quant-panel-title">👥 Complete User Registry</h3>
            <div class="quant-users-registry">
                {% if all_users %}
                    <div class="user-list">
                        {% for user in all_users %}
                            <div class="user-item">
                                <div>
                                    <span class="user-name">
                                        {% if user.is_performer %}
                                            🎪
                                        {% else %}
                                            👥
                                        {% endif %}
                                        {{ user.username }}
                                    </span>
                                    <div class="meta-text">
                                        {{ "Performer" if user.is_performer else "Audience" }} |
                                        Joined: {{ user.created_at.strftime("%Y-%m-%d") if user.created_at else 'Unknown' }}
                                    </div>
                                </div>
                                <span class="user-balance">{{ "{:,}".format(user.coin_balance) }} coins</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No users found</p>
                {% endif %}
            </div>
        </div>
        <!-- Live Market Data Display -->
        <div class="quant-panel">
            <h3 class="quant-panel-title">📊 Live Market Data</h3>
            <div id="marketDataDisplay" class="quant-data-display">
                <div class="market-stats-grid">
                    <div class="stat-card">
                        <h4>💰 Total Coins</h4>
                        <p class="stat-value" id="totalCoins">{{ "{:,}".format(market_cap) }}</p>
                    </div>
                    <div class="stat-card">
                        <h4>👥 Total Users</h4>
                        <p class="stat-value" id="totalUsers">{{ stakeholder_count }}</p>
                    </div>
                    <div class="stat-card">
                        <h4>🎪 Performers</h4>
                        <p class="stat-value" id="totalPerformers">{{ performer_count }}</p>
                    </div>
                    <div class="stat-card">
                        <h4>👁️ Audience</h4>
                        <p class="stat-value" id="totalAudience">{{ audience_count }}</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Terminal Log -->
        <div class="quant-panel">
            <h3 class="quant-panel-title">📝 Transfer Manipulation Log</h3>
            <div id="quantLog" class="quant-terminal-log">
                <div class="log-entry log-info">
                    <span class="log-timestamp">[SYSTEM]</span>
                    <span class="log-message">The CHANCELLOR Terminal initialized successfully</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Status Display -->
    <div id="quantStatus" class="message"></div>
    <script>
    // Pass current username to JavaScript
    window.currentUsername = '{{ current_username }}';
    window.quantEnabled = {{ 'true' if quant_enabled else 'false' }};
    </script>
    <script src="{{ url_for('static', filename='js/quant_terminal.js') }}"></script>
{% endblock %}
